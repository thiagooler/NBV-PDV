// --- ESTRUTURA DE DADOS ---
        let db = { 
            products: [], 
            clients: [], 
            sales: [],
            settings: {
                printWidth: '48mm', printFont: '12px', pixKey: '', payMethods: 'Pix,Dinheiro,Cart√£o',
                headerText: 'STUDIO NBV\nBoa Ventura de S√£o Roque', footerText: 'Obrigado pela prefer√™ncia!'
            }
        };
        let cart = [];
        let auth = JSON.parse(localStorage.getItem('nbv_auth')) || { user: '', repo: '', token: '' };
        let fileSha = '';

        // --- CORE & SYNC ---
        function applySettings() {
            const s = db.settings;
            document.documentElement.style.setProperty('--print-width', s.printWidth);
            document.documentElement.style.setProperty('--print-font', s.printFont);
        }

        async function ghRequest(method, body = null) {
            if(!auth.user || !auth.repo || !auth.token) return openConfig();
            document.getElementById('loader').style.width = '50%';
            try {
                const url = `https://api.github.com/repos/${auth.user}/${auth.repo}/contents/db.json`;
                const headers = { 'Authorization': `token ${auth.token}`, 'Accept': 'application/vnd.github.v3+json' };
                const fetchUrl = method === 'GET' ? `${url}?t=${Date.now()}` : url;
                const options = { method, headers, body: body ? JSON.stringify(body) : null };
                const res = await fetch(fetchUrl, options);
                document.getElementById('loader').style.width = '100%';
                setTimeout(()=>document.getElementById('loader').style.width='0%', 500);
                if (!res.ok) throw new Error(res.status);
                return await res.json();
            } catch (e) { alert('Erro GitHub: ' + e.message); return null; }
        }

        function toBase64(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1))); }
        function fromBase64(str) { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }

        async function loadData() {
            const data = await ghRequest('GET');
            if (data) {
                fileSha = data.sha;
                const remoteDb = JSON.parse(fromBase64(data.content));
                db.products = remoteDb.products || [];
                db.clients = remoteDb.clients || [];
                db.sales = remoteDb.sales || [];
                if(remoteDb.settings) db.settings = remoteDb.settings;
                // Normaliza√ß√£o
                db.products = db.products.map(p => ({...p, bulkMin: p.bulkMin||0, bulkPrice: p.bulkPrice||0 }));
                applySettings(); renderAll();
            }
        }

        async function saveData() {
            if (!fileSha) await loadData();
            const body = { message: "Sync PDV", content: toBase64(JSON.stringify(db)), sha: fileSha };
            const res = await ghRequest('PUT', body);
            if(res) fileSha = res.content.sha;
        }

        // --- NAVEGA√á√ÉO ---
        function nav(id) {
            document.querySelectorAll('.panel, .pdv-container').forEach(el => el.style.display = 'none');
            const t = document.getElementById(id);
            if(t) t.style.display = (id === 'pdv') ? 'flex' : 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(id === 'history') renderHistory();
        }

        function openConfig() { 
            document.getElementById('gh-user').value = auth.user || '';
            document.getElementById('gh-repo').value = auth.repo || '';
            document.getElementById('gh-token').value = auth.token || '';
            const s = db.settings;
            document.getElementById('cfg-print-width').value = s.printWidth;
            document.getElementById('cfg-print-font').value = s.printFont;
            document.getElementById('cfg-pix-key').value = s.pixKey || '';
            document.getElementById('cfg-pay-methods').value = s.payMethods;
            document.getElementById('cfg-header').value = s.headerText;
            document.getElementById('cfg-footer').value = s.footerText;
            document.getElementById('config-modal').style.display = 'flex'; 
        }

        function saveConfig() {
            auth = {
                user: document.getElementById('gh-user').value.trim(),
                repo: document.getElementById('gh-repo').value.trim(),
                token: document.getElementById('gh-token').value.trim()
            };
            localStorage.setItem('nbv_auth', JSON.stringify(auth));
            db.settings = {
                printWidth: document.getElementById('cfg-print-width').value.trim() || '48mm',
                printFont: document.getElementById('cfg-print-font').value.trim() || '12px',
                pixKey: document.getElementById('cfg-pix-key').value.trim(),
                payMethods: document.getElementById('cfg-pay-methods').value.trim(),
                headerText: document.getElementById('cfg-header').value,
                footerText: document.getElementById('cfg-footer').value
            };
            applySettings();
            document.getElementById('config-modal').style.display = 'none';
            saveData(); loadData();
        }

        // --- LOGICA PRODUTOS/CLIENTES ---
        function addProduct() {
            const name = document.getElementById('p-name').value;
            const price = parseFloat(document.getElementById('p-price').value);
            if(name && price) {
                db.products.push({
                    id: Date.now(), name, code: document.getElementById('p-code').value, price,
                    bulkMin: parseInt(document.getElementById('p-bulk-min').value)||0,
                    bulkPrice: parseFloat(document.getElementById('p-bulk-price').value)||0
                });
                saveData(); renderAll();
                document.getElementById('p-name').value = '';
            }
        }

        function addClient(isQuick) {
            const prefix = isQuick ? 'qc' : 'c';
            const name = document.getElementById(prefix+'-name').value;
            const phone = document.getElementById(prefix+'-phone').value;
            const addr = document.getElementById(prefix+'-addr').value;
            if(name) {
                const newClient = {id: Date.now(), name, phone, addr};
                db.clients.push(newClient);
                saveData(); 
                if(isQuick) { renderClientSelect(); document.getElementById('checkout-client').value = newClient.id; toggleQuickClient(); } 
                else renderAll();
                document.getElementById(prefix+'-name').value = '';
            }
        }

        function toggleQuickClient() { const f = document.getElementById('quick-client-form'); f.style.display = f.style.display === 'block' ? 'none' : 'block'; }
        
        function renderAll() {
            const term = document.getElementById('search').value.toLowerCase();
            const grid = document.getElementById('grid'); grid.innerHTML = '';
            db.products.forEach(p => {
                if(p.name.toLowerCase().includes(term) || (p.code && p.code.includes(term))) {
                    const hasBulk = p.bulkMin > 0;
                    const d = document.createElement('div');
                    d.className = 'card';
                    d.innerHTML = `${hasBulk ? `<span class="badge-bulk">>${p.bulkMin}</span>` : ''}<b>${p.name}</b><br>R$ ${p.price.toFixed(2)}`;
                    d.onclick = () => addToCart(p);
                    grid.appendChild(d);
                }
            });
            document.getElementById('p-list').innerHTML = db.products.map(p => `<div>${p.name} <button onclick="del('products',${p.id})">x</button></div>`).join('');
            document.getElementById('c-list').innerHTML = db.clients.map(c => `<div>${c.name}</div>`).join('');
        }
        function del(type, id) { if(confirm('Apagar?')) { db[type] = db[type].filter(x => x.id !== id); saveData(); renderAll(); } }

        // --- CARRINHO ---
        function addToCart(p) {
            const ex = cart.find(x => x.id === p.id);
            if(ex) updateQty(cart.indexOf(ex), ex.qty + 1);
            else { cart.push({...p, qty: 1, currentPrice: p.price}); renderCart(); }
        }
        function updateQty(idx, newQty) {
            newQty = parseInt(newQty);
            if(newQty < 1) return;
            const item = cart[idx];
            const original = db.products.find(p => p.id === item.id);
            item.qty = newQty;
            if(original && original.bulkMin > 0 && newQty >= original.bulkMin) item.currentPrice = original.bulkPrice;
            else item.currentPrice = original ? original.price : item.price;
            renderCart();
        }
        function renderCart() {
            const list = document.getElementById('cart-list'); list.innerHTML = '';
            let total = 0;
            cart.forEach((i, idx) => {
                total += i.qty * i.currentPrice;
                const orig = db.products.find(p => p.id === i.id);
                const isBulk = orig && orig.bulkMin > 0 && i.qty >= orig.bulkMin;
                list.innerHTML += `<div class="cart-item">
                    <div style="flex:2"><b>${i.name}</b>${isBulk ? ' <small style="color:orange">*</small>' : ''}</div>
                    <div style="flex:1"><input type="number" value="${i.qty}" style="width:40px" onchange="updateQty(${idx},this.value)"></div>
                    <div style="flex:1;text-align:right">R$ ${(i.qty*i.currentPrice).toFixed(2)} <span onclick="cart.splice(${idx},1);renderCart()" style="color:red;cursor:pointer">x</span></div>
                </div>`;
            });
            document.getElementById('total').innerText = total.toFixed(2);
        }

        // --- CHECKOUT ---
        let finalTotal = 0;
        function openCheckout() {
            if(!cart.length) return alert('Carrinho vazio');
            document.getElementById('checkout-modal').style.display = 'flex';
            renderClientSelect();
            document.getElementById('payment-list').innerHTML = '';
            document.getElementById('disc-val').value = 0;
            document.getElementById('gallery-link').value = '';
            document.getElementById('pix-display').style.display = 'none';
            calcTotal(); addPaymentRow(); 
        }
        function closeCheckout() { document.getElementById('checkout-modal').style.display = 'none'; }
        
        function renderClientSelect() {
            const sel = document.getElementById('checkout-client');
            sel.innerHTML = '<option value="">Consumidor Final</option>';
            db.clients.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }

        function calcTotal() {
            const sub = parseFloat(document.getElementById('total').innerText);
            const dVal = parseFloat(document.getElementById('disc-val').value) || 0;
            const dType = document.getElementById('disc-type').value;
            let discount = (dType === '%') ? sub * (dVal/100) : dVal;
            finalTotal = Math.max(0, sub - discount);
            document.getElementById('checkout-final').innerText = finalTotal.toFixed(2);
            return finalTotal;
        }

        function addPaymentRow() {
            let currentPaid = 0;
            document.querySelectorAll('.pay-amount').forEach(el => currentPaid += parseFloat(el.value)||0);
            const remaining = Math.max(0, finalTotal - currentPaid);
            const div = document.createElement('div');
            div.className = 'payment-row';
            const opts = db.settings.payMethods.split(',').map(m => `<option>${m.trim()}</option>`).join('');
            div.innerHTML = `<select class="pay-method" onchange="checkPixRow(this)">${opts}</select><input type="number" class="pay-amount" value="${remaining.toFixed(2)}" step="0.01" onchange="updatePixDisplay()"><label class="pix-check-label" style="display:none"><input type="checkbox" class="pix-print"> üñ®Ô∏è QR</label><button onclick="this.parentElement.remove();updatePixDisplay()" style="background:#c0392b;color:white;border:none;">x</button>`;
            document.getElementById('payment-list').appendChild(div);
            checkPixRow(div.querySelector('.pay-method'));
        }

        function checkPixRow(sel) {
            const isPix = sel.value.toLowerCase().includes('pix');
            sel.parentElement.querySelector('.pix-check-label').style.display = isPix ? 'flex' : 'none';
            updatePixDisplay();
        }

        function updatePixDisplay() {
            const pixRow = Array.from(document.querySelectorAll('.payment-row')).find(r => r.querySelector('.pay-method').value.toLowerCase().includes('pix'));
            const display = document.getElementById('pix-display');
            const key = db.settings.pixKey;
            
            if(pixRow && key) {
                const amt = pixRow.querySelector('.pay-amount').value;
                // Gera um ID √∫nico para esta transa√ß√£o baseada na hora atual
                const txid = "NBV" + Date.now().toString().slice(-10);
                const payload = createPixPayload(key, "Studio NBV", "Boa Ventura", amt, txid);
                
                display.style.display = 'block';
                display.setAttribute('data-code', payload);
                const qrDiv = document.getElementById('pix-qrcode-checkout'); qrDiv.innerHTML = '';
                new QRCode(qrDiv, { text: payload, width: 120, height: 120 });
            } else { display.style.display = 'none'; }
        }
        function copyPix() { navigator.clipboard.writeText(document.getElementById('pix-display').getAttribute('data-code')); alert('Copiado!'); }

        function finishOrder() {
            const payRows = document.querySelectorAll('.payment-row');
            let payments = []; let pixPrintData = null;
            payRows.forEach(r => {
                const method = r.querySelector('.pay-method').value;
                const val = parseFloat(r.querySelector('.pay-amount').value) || 0;
                const printQr = r.querySelector('.pix-print').checked;
                const key = db.settings.pixKey;
                if(val > 0) {
                    payments.push({ method, val });
                    if(method.toLowerCase().includes('pix') && printQr && key) {
                        const txid = "NBV" + Date.now().toString().slice(-10);
                        pixPrintData = { payload: createPixPayload(key, "Studio NBV", "Boa Ventura", val, txid), val: val };
                    }
                }
            });
            const client = db.clients.find(c => c.id == document.getElementById('checkout-client').value);
            const sale = {
                id: Date.now(),
                date: new Date().toLocaleString('pt-BR'),
                client: client ? client.name : 'Consumidor Final',
                addr: client ? client.addr : '',
                items: cart.map(i => ({...i, price: i.currentPrice})),
                subtotal: parseFloat(document.getElementById('total').innerText),
                discount: (parseFloat(document.getElementById('total').innerText) - finalTotal),
                total: finalTotal,
                payments: payments,
                link: document.getElementById('gallery-link').value,
                pixPrint: pixPrintData,
                header: db.settings.headerText,
                footer: db.settings.footerText
            };
            db.sales.push(sale); saveData(); printReceipt(sale); cart = []; renderCart(); closeCheckout();
        }

        function printReceipt(sale) {
            document.getElementById('rec-header').innerText = sale.header;
            document.getElementById('rec-footer').innerText = sale.footer;
            document.getElementById('rec-meta').innerHTML = `Data: ${sale.date}<br>Cliente: ${sale.client}`;
            document.getElementById('rec-addr').innerText = sale.addr ? `End: ${sale.addr}` : '';
            document.getElementById('rec-items').innerHTML = sale.items.map(i => `<tr><td>${i.qty}x ${i.name}</td><td align="right">R$ ${(i.qty*i.price).toFixed(2)}</td></tr>`).join('');
            document.getElementById('rec-sub').innerText = sale.subtotal.toFixed(2);
            document.getElementById('rec-disc').innerText = sale.discount.toFixed(2);
            document.getElementById('rec-total-val').innerText = sale.total.toFixed(2);
            document.getElementById('rec-payments').innerHTML = sale.payments.map(p => `<div>${p.method}: R$ ${p.val.toFixed(2)}</div>`).join('');
            
            const recPix = document.getElementById('rec-pix-area');
            if(sale.pixPrint) {
                recPix.style.display = 'block';
                document.getElementById('rec-qrcode-pix').innerHTML = '';
                new QRCode(document.getElementById('rec-qrcode-pix'), { text: sale.pixPrint.payload, width: 250, height: 250, correctLevel: QRCode.CorrectLevel.L });
                document.getElementById('rec-pix-val').innerText = `Valor: R$ ${sale.pixPrint.val.toFixed(2)}`;
            } else { recPix.style.display = 'none'; }

            const qrC = document.getElementById('qrcode'); qrC.innerHTML = '';
            if(sale.link) {
                document.getElementById('qr-area').style.display = 'block';
                new QRCode(qrC, { text: sale.link, width: 100, height: 100 });
            } else document.getElementById('qr-area').style.display = 'none';
            setTimeout(() => window.print(), 500);
        }

        function renderHistory() {
            const list = document.getElementById('h-list');
            list.innerHTML = [...db.sales].sort((a,b)=>b.id-a.id).map(s => 
                `<div class="history-item"><div><strong>${s.date}</strong> - ${s.client}<br>R$ ${s.total.toFixed(2)}</div><button class="btn" onclick='printReceipt(${JSON.stringify(s)})'>üñ®Ô∏è</button></div>`
            ).join('');
        }

        // --- GERA√á√ÉO PIX VALIDADA PELO BANCO CENTRAL ---
        function normalizeStr(str) {
            return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-zA-Z0-9 ]/g, "").toUpperCase();
        }

        function createPixPayload(key, name, city, amount, txid) {
            const cleanKey = key.trim();
            const cleanName = normalizeStr(name).substring(0, 25);
            const cleanCity = normalizeStr(city).substring(0, 15);
            const cleanTxid = normalizeStr(txid).substring(0, 25) || "***";
            const cleanAmount = parseFloat(amount).toFixed(2);

            function f(id, v) { return id + v.length.toString().padStart(2, '0') + v; }

            // Montagem do Payload (EMV QRCPS MPM)
            let p = "00020126" + (14 + cleanKey.length + 4) + "0014BR.GOV.BCB.PIX01" + (cleanKey.length).toString().padStart(2, '0') + cleanKey;
            p += "52040000"; // Merchant Cat Code
            p += "5303986"; // Moeda BRL
            if (parseFloat(amount) > 0) p += f("54", cleanAmount); // Valor
            p += "5802BR"; // Pa√≠s
            p += f("59", cleanName); // Nome Recebedor
            p += f("60", cleanCity); // Cidade Recebedor
            
            // O ERRO ESTAVA AQUI: O Campo 62 precisa ter o subcampo 05 dentro dele!
            p += f("62", f("05", cleanTxid));

            p += "6304"; // Placeholder CRC

            // C√°lculo CRC16 (Polin√¥mio 0x1021)
            let crc = 0xFFFF;
            for (let i = 0; i < p.length; i++) {
                crc ^= p.charCodeAt(i) << 8;
                for (let j = 0; j < 8; j++) {
                    if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                    else crc = crc << 1;
                }
            }
            return p + (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
        }

        if(auth.token) loadData(); else openConfig();
