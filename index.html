<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio NBV - PDV 2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #e67e22; --success: #27ae60; --danger: #c0392b; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f4f4; display: flex; height: 100vh; overflow: hidden; }
        
        /* Layout */
        #sidebar { width: 80px; background: var(--primary); display: flex; flex-direction: column; align-items: center; padding-top: 20px; color: white; }
        .nav-btn { background: none; border: none; color: white; font-size: 24px; margin-bottom: 20px; cursor: pointer; transition: 0.3s; opacity: 0.7; }
        .nav-btn:hover, .nav-btn.active { opacity: 1; transform: scale(1.1); }
        .nav-bottom { margin-top: auto; margin-bottom: 20px; }

        #main-content { flex: 1; display: flex; overflow: hidden; position: relative; }
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: transparent; z-index: 2000; }
        .loading-line { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }

        /* PDV */
        .pdv-container { display: flex; width: 100%; height: 100%; }
        .product-area { flex: 2; padding: 20px; overflow-y: auto; border-right: 1px solid #ddd; }
        .cart-area { flex: 1; background: white; display: flex; flex-direction: column; box-shadow: -2px 0 5px rgba(0,0,0,0.05); }

        /* Componentes */
        .search-bar { width: 100%; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; text-align: center; border: 1px solid transparent; }
        .card:hover { border-color: var(--accent); transform: translateY(-2px); }
        
        /* Carrinho */
        .cart-list { flex: 1; overflow-y: auto; padding: 10px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        .cart-footer { padding: 20px; background: #f8f9fa; border-top: 1px solid #ddd; }
        .btn-checkout { width: 100%; padding: 15px; background: var(--success); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }

        /* Pain√©is e Forms */
        .panel { padding: 30px; width: 100%; overflow-y: auto; display: none; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 12px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; }
        
        /* Modais */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 500px; max-width: 95%; max-height: 90vh; overflow-y: auto; }
        
        /* Pagamentos Multiplos */
        .payment-row { display: flex; gap: 5px; margin-bottom: 5px; }
        .payment-row select { flex: 1; }
        .payment-row input { width: 100px; }

        /* Cadastro R√°pido de Cliente */
        #quick-client-form { display: none; background: #f0f0f0; padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px dashed #999; }

        /* Hist√≥rico */
        .history-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 5px solid var(--accent); box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }

        /* --- CSS IMPRESS√ÉO (58mm) --- */
        @media print {
            body * { visibility: hidden; }
            #receipt, #receipt * { visibility: visible; }
            #receipt { 
                position: absolute; left: 0; top: 0; 
                width: 48mm; /* Margem de seguran√ßa para 58mm */
                margin: 0 auto; padding: 5px; 
                font-family: 'Arial Black', 'Arial', sans-serif; /* Fonte Grossa */
                font-weight: 900;
                font-size: 12px;
                color: #000;
                line-height: 1.2;
                display: block !important; 
            }
            .rec-line { border-bottom: 2px dashed #000; margin: 5px 0; }
            .rec-header { text-align: center; font-size: 14px; margin-bottom: 10px; }
            .rec-total { font-size: 16px; text-align: right; margin-top: 5px; }
            #qrcode img { margin: 10px auto; display: block; max-width: 100px; }
            @page { size: 58mm auto; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <button class="nav-btn active" onclick="nav('pdv')" title="Caixa">üõí</button>
        <button class="nav-btn" onclick="nav('products')" title="Produtos">üì¶</button>
        <button class="nav-btn" onclick="nav('clients')" title="Clientes">üë•</button>
        <button class="nav-btn" onclick="nav('history')" title="Hist√≥rico">üìú</button>
        <div class="nav-bottom">
            <button class="nav-btn" onclick="openConfig()" title="Config GitHub">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="main-content">
        <div id="status-bar"><div class="loading-line" id="loader"></div></div>

        <div id="pdv" class="pdv-container">
            <div class="product-area">
                <input type="text" id="search" class="search-bar" placeholder="Buscar produto..." onkeyup="renderGrid()">
                <div id="grid" class="grid"></div>
            </div>
            <div class="cart-area">
                <div class="cart-header"><h2>Carrinho</h2></div>
                <div id="cart-list" class="cart-list"></div>
                <div class="cart-footer">
                    <h2 style="text-align:right; margin:0 0 10px 0">R$ <span id="total">0.00</span></h2>
                    <button class="btn-checkout" onclick="openCheckout()">FINALIZAR</button>
                </div>
            </div>
        </div>

        <div id="products" class="panel">
            <h2>Gerenciar Produtos</h2>
            <div class="form-group"><input id="p-name" placeholder="Nome"></div>
            <div class="form-group"><input id="p-code" placeholder="C√≥digo"></div>
            <div class="form-group"><input id="p-price" type="number" step="0.01" placeholder="Pre√ßo"></div>
            <button class="btn" onclick="addProduct()">Salvar Produto</button>
            <hr>
            <div id="p-list"></div>
        </div>

        <div id="clients" class="panel">
            <h2>Gerenciar Clientes</h2>
            <div class="form-group"><input id="c-name" placeholder="Nome"></div>
            <div class="form-group"><input id="c-phone" placeholder="WhatsApp"></div>
            <button class="btn" onclick="addClient(false)">Salvar Cliente</button>
            <hr>
            <div id="c-list"></div>
        </div>

        <div id="history" class="panel">
            <h2>Hist√≥rico de Vendas</h2>
            <button class="btn" onclick="loadData()">üîÑ Atualizar Lista</button>
            <hr>
            <div id="h-list"></div>
        </div>
    </div>

    <div id="config-modal" class="modal">
        <div class="modal-content">
            <h3>Conex√£o GitHub</h3>
            <div class="form-group"><label>Usu√°rio:</label><input id="gh-user"></div>
            <div class="form-group"><label>Reposit√≥rio:</label><input id="gh-repo"></div>
            <div class="form-group"><label>Token:</label><input type="password" id="gh-token"></div>
            <button class="btn" onclick="saveConfig()">Salvar e Conectar</button>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="modal-content">
            <h3>Finalizar Venda</h3>
            
            <div class="form-group" style="display:flex; gap:5px; align-items:end;">
                <div style="flex:1">
                    <label>Cliente:</label>
                    <select id="checkout-client"></select>
                </div>
                <button class="btn" onclick="toggleQuickClient()" title="Novo Cliente" style="padding: 10px;">+</button>
            </div>

            <div id="quick-client-form">
                <h4>Novo Cliente R√°pido</h4>
                <div class="form-group"><input id="qc-name" placeholder="Nome Completo"></div>
                <div class="form-group"><input id="qc-phone" placeholder="WhatsApp"></div>
                <button class="btn" style="background:var(--success)" onclick="addClient(true)">Cadastrar Agora</button>
            </div>

            <div class="form-group">
                <label>Pagamentos (Total: R$ <span id="checkout-total">0.00</span>)</label>
                <div id="payment-list"></div>
                <button class="btn" style="background:#ddd; color:black; width:100%; margin-top:5px;" onclick="addPaymentRow()">+ Adicionar Forma de Pagamento</button>
            </div>

            <div class="form-group">
                <label>Link da Galeria (Gera QR Code):</label>
                <input type="text" id="gallery-link" placeholder="https://...">
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn" style="background:#ccc; flex:1" onclick="closeCheckout()">Cancelar</button>
                <button class="btn-checkout" style="flex:1" onclick="finishOrder()">IMPRIMIR</button>
            </div>
        </div>
    </div>

    <div id="receipt" style="display:none">
        <div class="rec-header">
            <strong>STUDIO NBV</strong><br>
            Fotografia & Impress√£o<br>
            Boa Ventura de S√£o Roque
        </div>
        <div class="rec-line"></div>
        <div id="rec-meta"></div>
        <div class="rec-line"></div>
        <table style="width:100%" id="rec-items"></table>
        <div class="rec-line"></div>
        <div class="rec-total">TOTAL: R$ <span id="rec-total-val"></span></div>
        <div id="rec-payments" style="text-align:right; font-size:10px;"></div>
        
        <div id="qr-area" style="text-align:center; margin-top:10px; display:none;">
            <span>Acesse suas fotos:</span>
            <div id="qrcode"></div>
        </div>
        
        <div style="text-align:center; margin-top:15px; font-size:10px;">
            Obrigado pela prefer√™ncia!<br>Volte Sempre.
        </div>
    </div>

    <script>
        // --- CORE ---
        let db = { products: [], clients: [], sales: [] };
        let cart = [];
        let config = JSON.parse(localStorage.getItem('nbv_gh_config')) || {};
        let fileSha = '';

        // --- GITHUB ---
        async function ghRequest(method, body = null) {
            const { user, repo, token } = config;
            if(!user || !repo || !token) return openConfig();
            document.getElementById('loader').style.width = '50%';
            
            try {
                const url = `https://api.github.com/repos/${user}/${repo}/contents/db.json`;
                const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' };
                const fetchUrl = method === 'GET' ? `${url}?t=${Date.now()}` : url;
                const options = { method, headers, body: body ? JSON.stringify(body) : null };
                
                const res = await fetch(fetchUrl, options);
                document.getElementById('loader').style.width = '100%';
                setTimeout(()=>document.getElementById('loader').style.width='0%', 500);
                
                if (!res.ok) throw new Error(res.status);
                return await res.json();
            } catch (e) {
                alert('Erro GitHub: ' + e.message);
                return null;
            }
        }

        function toBase64(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1))); }
        function fromBase64(str) { return decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')); }

        async function loadData() {
            const data = await ghRequest('GET');
            if (data) {
                fileSha = data.sha;
                db = JSON.parse(fromBase64(data.content));
                if(!db.sales) db.sales = []; // Garante compatibilidade
                renderAll();
            }
        }

        async function saveData() {
            if (!fileSha) await loadData();
            const body = { message: "Sync PDV", content: toBase64(JSON.stringify(db)), sha: fileSha };
            const res = await ghRequest('PUT', body);
            if(res) fileSha = res.content.sha;
        }

        // --- UI GERAL ---
        function nav(id) {
            document.querySelectorAll('.panel, .pdv-container').forEach(el => el.style.display = 'none');
            const t = document.getElementById(id);
            if(t) t.style.display = (id === 'pdv') ? 'flex' : 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(id === 'history') renderHistory();
        }

        function openConfig() { document.getElementById('config-modal').style.display = 'flex'; }
        function saveConfig() {
            config = {
                user: document.getElementById('gh-user').value.trim(),
                repo: document.getElementById('gh-repo').value.trim(),
                token: document.getElementById('gh-token').value.trim()
            };
            localStorage.setItem('nbv_gh_config', JSON.stringify(config));
            document.getElementById('config-modal').style.display = 'none';
            loadData();
        }

        // --- GEST√ÉO ---
        function addProduct() {
            const name = document.getElementById('p-name').value;
            const price = parseFloat(document.getElementById('p-price').value);
            if(name && price) {
                db.products.push({id: Date.now(), name, code: document.getElementById('p-code').value, price});
                saveData(); renderAll();
                document.getElementById('p-name').value = '';
            }
        }

        function addClient(isQuick) {
            const prefix = isQuick ? 'qc' : 'c';
            const name = document.getElementById(prefix+'-name').value;
            const phone = document.getElementById(prefix+'-phone').value;
            
            if(name) {
                const newClient = {id: Date.now(), name, phone};
                db.clients.push(newClient);
                saveData(); 
                
                if(isQuick) {
                    renderClientSelect();
                    document.getElementById('checkout-client').value = newClient.id; // Seleciona automaticamente
                    toggleQuickClient(); // Fecha o form rapido
                } else {
                    renderAll();
                }
                
                document.getElementById(prefix+'-name').value = '';
                document.getElementById(prefix+'-phone').value = '';
            }
        }

        function toggleQuickClient() {
            const form = document.getElementById('quick-client-form');
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
        }

        function renderAll() {
            // Grid Produtos
            const term = document.getElementById('search').value.toLowerCase();
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            db.products.forEach(p => {
                if(p.name.toLowerCase().includes(term) || (p.code && p.code.includes(term))) {
                    const d = document.createElement('div');
                    d.className = 'card';
                    d.innerHTML = `<b>${p.name}</b><br>R$ ${p.price.toFixed(2)}`;
                    d.onclick = () => addToCart(p);
                    grid.appendChild(d);
                }
            });

            // Listas
            document.getElementById('p-list').innerHTML = db.products.map(p => `<div>${p.name} <button onclick="del('products',${p.id})">x</button></div>`).join('');
            document.getElementById('c-list').innerHTML = db.clients.map(c => `<div>${c.name}</div>`).join('');
        }

        function del(type, id) {
            if(confirm('Apagar?')) {
                db[type] = db[type].filter(x => x.id !== id);
                saveData(); renderAll();
            }
        }

        // --- CART ---
        function addToCart(p) {
            const ex = cart.find(x => x.id === p.id);
            if(ex) ex.qty++; else cart.push({...p, qty: 1});
            renderCart();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            list.innerHTML = '';
            let total = 0;
            cart.forEach((i, idx) => {
                total += i.qty * i.price;
                list.innerHTML += `<div class="cart-item">
                    <div style="flex:2"><b>${i.name}</b></div>
                    <div style="flex:1"><input type="number" value="${i.qty}" style="width:40px" onchange="cart[${idx}].qty=this.value;renderCart()"></div>
                    <div style="flex:1;text-align:right">R$ ${(i.qty*i.price).toFixed(2)} <span onclick="cart.splice(${idx},1);renderCart()" style="color:red;cursor:pointer">x</span></div>
                </div>`;
            });
            document.getElementById('total').innerText = total.toFixed(2);
            document.getElementById('checkout-total').innerText = total.toFixed(2);
        }

        // --- CHECKOUT COMPLEXO ---
        function openCheckout() {
            if(!cart.length) return alert('Carrinho vazio');
            document.getElementById('checkout-modal').style.display = 'flex';
            renderClientSelect();
            document.getElementById('payment-list').innerHTML = '';
            addPaymentRow(); // Inicia com uma linha
            document.getElementById('gallery-link').value = '';
        }

        function closeCheckout() { document.getElementById('checkout-modal').style.display = 'none'; }

        function renderClientSelect() {
            const sel = document.getElementById('checkout-client');
            sel.innerHTML = '<option value="">Consumidor Final</option>';
            db.clients.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }

        function addPaymentRow() {
            const div = document.createElement('div');
            div.className = 'payment-row';
            div.innerHTML = `
                <select class="pay-method">
                    <option>Pix</option><option>Dinheiro</option><option>Cart√£o Cr√©dito</option><option>Cart√£o D√©bito</option>
                </select>
                <input type="number" class="pay-amount" step="0.01" placeholder="Valor">
                <button onclick="this.parentElement.remove()" style="background:#c0392b;color:white;border:none;">x</button>
            `;
            document.getElementById('payment-list').appendChild(div);
        }

        function finishOrder() {
            // Coletar Pagamentos
            const payRows = document.querySelectorAll('.payment-row');
            let payments = [];
            let payTotal = 0;
            payRows.forEach(row => {
                const method = row.querySelector('.pay-method').value;
                const val = parseFloat(row.querySelector('.pay-amount').value) || 0;
                if(val > 0) {
                    payments.push({ method, val });
                    payTotal += val;
                }
            });

            // Validar
            const cartTotal = parseFloat(document.getElementById('total').innerText);
            // Aviso opcional se o valor n√£o bater, mas deixamos passar para flexibilidade (descontos, etc)
            
            // Dados da Venda
            const clientId = document.getElementById('checkout-client').value;
            const clientObj = db.clients.find(c => c.id == clientId);
            const clientName = clientObj ? clientObj.name : 'Consumidor Final';
            const link = document.getElementById('gallery-link').value;
            
            const sale = {
                id: Date.now(),
                date: new Date().toLocaleString('pt-BR'),
                client: clientName,
                items: cart,
                total: cartTotal,
                payments: payments,
                link: link
            };

            // Salvar
            db.sales.push(sale);
            saveData();
            
            // Imprimir
            printReceipt(sale);

            // Reset
            cart = [];
            renderCart();
            closeCheckout();
        }

        // --- IMPRESS√ÉO & QR ---
        function printReceipt(sale) {
            // Preencher dados
            document.getElementById('rec-meta').innerHTML = `Data: ${sale.date}<br>Cliente: ${sale.client}`;
            
            let html = '';
            sale.items.forEach(i => {
                html += `<tr><td>${i.qty}x ${i.name}</td><td align="right">R$ ${(i.qty*i.price).toFixed(2)}</td></tr>`;
            });
            document.getElementById('rec-items').innerHTML = html;
            document.getElementById('rec-total-val').innerText = sale.total.toFixed(2);
            
            // Pagamentos
            let payHtml = '';
            sale.payments.forEach(p => payHtml += `<div>${p.method}: R$ ${p.val.toFixed(2)}</div>`);
            document.getElementById('rec-payments').innerHTML = payHtml;

            // QR Code
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            const qrArea = document.getElementById('qr-area');
            
            if(sale.link) {
                qrArea.style.display = 'block';
                new QRCode(qrContainer, {
                    text: sale.link,
                    width: 100,
                    height: 100,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L
                });
            } else {
                qrArea.style.display = 'none';
            }

            // Delay para renderizar o QR Code antes de imprimir
            setTimeout(() => window.print(), 500);
        }

        // --- HIST√ìRICO ---
        function renderHistory() {
            const list = document.getElementById('h-list');
            // Ordenar por mais recente
            const sorted = [...db.sales].sort((a,b) => b.id - a.id);
            
            list.innerHTML = sorted.map(s => `
                <div class="history-item">
                    <div>
                        <strong>${s.date}</strong> - ${s.client}<br>
                        R$ ${s.total.toFixed(2)} (${s.items.length} itens)
                    </div>
                    <button class="btn" onclick='reprint(${JSON.stringify(s)})'>üñ®Ô∏è</button>
                </div>
            `).join('');
        }

        function reprint(sale) {
            printReceipt(sale);
        }

        // Init
        if(config.token) loadData(); else openConfig();

    </script>
</body>
</html>
